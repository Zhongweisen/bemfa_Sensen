var t=[0,50585,52907,2866,55503,7510,5732,54269,62471,12702,15020,65333,11464,59729,57955,10234,44439,26638,25404,42661,30040,45249,48115,32362,22928,39945,38715,21154,33119,17606,20468,35437,23342,40631,38277,20508,33761,18040,19786,35027,44841,27312,24962,42011,30694,45695,47437,31956,63161,13088,14354,64907,11894,60399,57565,9540,702,50983,52245,2444,55921,8168,5338,53571,62405,13916,15726,63735,11018,61075,58785,8248,1986,49755,51561,3312,57101,6804,4518,54335,24146,39883,37113,21856,34461,17156,18486,36271,43605,28620,25854,41319,29338,46851,48177,31144,43243,28018,26176,41945,28708,46525,48783,31510,23788,39285,37447,22494,33827,16826,19080,36625,1404,49381,52183,3662,56755,6186,4888,54913,61819,13538,16336,64073,10676,60461,59167,8838,41491,26506,27832,43297,31452,48965,46199,29166,22036,37773,39103,23846,36571,19266,16496,34281,3972,51741,49455,1206,55115,4818,6624,56441,64387,15898,13608,61617,9036,59093,60903,10366,63805,15524,14230,61967,8690,58475,61273,10944,3386,51363,50065,1544,54773,4204,7006,57031,21674,37171,39425,24472,35941,18940,17102,34647,41133,25908,28166,43935,30818,48635,46793,29520,20950,37967,40829,23268,35097,19584,18354,33323,42449,24648,27514,44771,32030,47239,46005,30252,64577,14808,13034,63347,9358,57623,59941,12220,2118,52703,50925,884,53385,5392,7714,56251,2808,53089,50259,458,53815,6062,7324,55557,65279,15206,12372,62925,9776,58281,59547,11522,42863,25334,27076,44125,32672,47673,45323,29842,21352,38641,40387,22618,35751,20030,17676,32917],e=getApp(),a=new ArrayBuffer(6),i=0,r=0,s=!0,n=new Float32Array(60),o=0,l=0,d="";function u(t){wx.showToast({title:t,icon:"none",duration:2e3})}function c(e,a){for(var i=16,r=0,s=new Uint8Array(a),n=0;n<e;n++)r=255&(i>>7^s[n]),i=65535&(i<<8^t[r]);return 2*(i&=65535)}Page({data:{passWord:"12345678",device:null,deviceadd:"  ",showwarn:"  ",connected:!1,autoConnectEn:!1,autoConnectconut:0,equaloff:0,autoTimerOK:!1,keyStatus:"功能选择",currentTab:0,currentCanvas:null,switchOutStatus:!1,switchInStatus:!1,autoSendEn:!0,isReNameEN:!0,isRePassWordEN:!0,isCurrentOutAdjustEN:!0,isCurrentInAdjustEN:!0,settingSendChoose:0,repassword:0,recurrent:0,rebluename:"",isSwitchChange:0,mEvent_Status:0,mVoltage:0,showCurrent:0,mpower:0,battryIMG:["e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png"],equalIMG:["e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png","e.png"],equalText:["关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭","关闭"],t1:-90,t2:-90,mCurent_Out_SUM:0,mCurent_In_SUM:0,mOut_cycle:0,mBattery_capacity:0,showMax:0,showMin:0,max_Min:0,showaverage:0,showAllVoltage:0,showEqual:0,popshow:!1,pwEntertemp:0,cellVotage:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],order:3,sLength:0,blePassWord:0,mOffset_Voltage_OUT:0,mOffset_Voltage_IN:0,mCurrent_IN_Max:0,mCurrent_Out_Max:0,mCurrent_IN_Zero:0,mCurrent_OUT_Zero:0,mBattery_Count:0,mbattery_Type:0,mNC2:0,mDischarge_cycle:0,mBattery_Capacity:0,mBalanced_Open_Voltage:0,mReference_OUT_Voltage:0,mReference_IN_Voltage:0,mTotal_Discharge:0,mTotal_Recharge:0,mCell_voltage_discharge:0,mCell_voltage_overcharge:0,mMOS_Temperature_Protect:0,mCircuit_Temperature_Protect:0,mTemperature_Adjustment:0,serial_number:"SER",softDate:"VER",lowpower:0,mBattery4_Adjustment:0,mVoltage_Equal:0,mOvercharge_Release_Voltage:0,mOvercharge_Cell_voltage:0,mDischarge_Release_Voltage:0,mDischarge_Cell_Voltage:0,autoConnectCoun:0},swiperTab:function(t){this.setData({currentTab:t.detail.current}),this.GetCanvas(),this.data.settingSendChoose=0},clickTab:function(t){if(this.data.currentTab===t.currentTarget.dataset.current)return!1;this.setData({currentTab:t.currentTarget.dataset.current}),this.data.settingSendChoose=0},clearmCurent_In_SUM:function(t){new DataView(a).setUint16(0,52171),r=2},clearmCurent_Out_SUM:function(t){new DataView(a).setUint16(0,51914),r=3},readCFG:function(t){this.data.settingSendChoose=5,this.clearMore(),new DataView(a).setUint16(0,22102),r=4},saveCFG:function(t){if(0==this.data.settingSendChoose)u("请先读取配置文件");else if(1==this.data.settingSendChoose)this.sendcalibrationOUT(),this.setData({keyStatus:"功能设置",settingSendChoose:0});else if(2==this.data.settingSendChoose)this.sendcalibrationIN(),this.setData({keyStatus:"功能设置",settingSendChoose:0});else if(3==this.data.settingSendChoose)this.sendrePassWord(),this.setData({keyStatus:"功能设置",settingSendChoose:0});else if(4==this.data.settingSendChoose)this.sendreBlueName(),this.setData({keyStatus:"功能设置",settingSendChoose:0}),u("请退出APP15秒后再重新连接");else if(this.data.settingSendChoose=5){if(this.data.mCurrent_IN_Max>250)return void u("充电电流不能大于250");if(this.data.mCurrent_Out_Max>800)return void u("放电电流不能大于800");if(this.data.mBattery_Count>24)return void u("最大支持24串电池");if(this.data.mbattery_Type>15)return void u("1磷酸铁锂，2三元锂，保护");if(this.data.mBalanced_Open_Voltage<3.32)return void u("均衡开启电压不能小于3.32V");if(this.data.mTotal_Discharge<8||this.data.mTotal_Discharge>100)return void u("总电压过放设置错误");if(this.data.mTotal_Recharge<8||this.data.mTotal_Recharge>102)return void u("总电压过充设置错误");if(this.data.mCell_voltage_discharge<2.3||this.data.mCell_voltage_discharge>4.2)return void u("单体电压过放不能低于2.3v");if(this.data.mCell_voltage_overcharge<3||this.data.mCell_voltage_overcharge>4.35)return void u("单体电压过充不能高于4.35v");if(this.data.mMOS_Temperature_Protect<30||this.data.mCircuit_Temperature_Protect>90)return void u("温度保护设置错误");if(this.data.mVoltage_Equal<.01||this.data.mVoltage_Equal>.35)return void u("均衡开启压差范围0.01至0.35");if(this.data.mOvercharge_Release_Voltage<10||this.data.mOvercharge_Release_Voltage>this.data.mTotal_Recharge)return void u("总电压过充解除电压不能大于总过充电压");if(this.data.mOvercharge_Cell_voltage<2.8||this.data.mOvercharge_Cell_voltage>this.data.mCell_voltage_overcharge)return void u("单体过充解除电压不能大于单体过充电压");if(this.data.mDischarge_Release_Voltage<this.data.mTotal_Discharge||this.data.mDischarge_Release_Voltage>102)return void u("总电压过放解除不能小于总电压过放电压");if(this.data.mDischarge_Cell_Voltage<this.data.mCell_voltage_discharge||this.data.mDischarge_Cell_Voltage>3.8)return void u("单体过放解除电压不能小于单体过放电压");var e=new ArrayBuffer(108),a=new DataView(e);a.setUint16(0,27242),a.setUint32(2,this.data.blePassWord),a.setUint8(6,this.data.mOffset_Voltage_OUT),a.setUint8(7,this.data.mOffset_Voltage_IN),a.setUint16(8,this.data.mCurrent_IN_Max),a.setUint16(10,this.data.mCurrent_Out_Max),a.setUint8(12,this.data.mCurrent_IN_Zero),a.setUint8(13,this.data.mCurrent_OUT_Zero),a.setUint8(14,this.data.mBattery_Count),a.setUint8(15,this.data.mbattery_Type),a.setUint16(16,1),a.setUint16(18,this.data.mDischarge_cycle),a.setFloat32(20,this.data.mBattery_Capacity),a.setFloat32(24,this.data.mBalanced_Open_Voltage),a.setFloat32(28,1),a.setFloat32(32,this.data.mReference_OUT_Voltage),a.setFloat32(36,this.data.mReference_IN_Voltage),a.setFloat32(40,this.data.mTotal_Discharge),a.setFloat32(44,this.data.mTotal_Recharge),a.setFloat32(48,this.data.mCell_voltage_discharge),a.setFloat32(52,this.data.mCell_voltage_overcharge),a.setFloat32(56,this.data.mMOS_Temperature_Protect),a.setFloat32(60,this.data.mCircuit_Temperature_Protect),a.setFloat32(64,this.data.mTemperature_Adjustment),a.setFloat32(68,this.data.serial_number),a.setFloat32(72,this.data.softDate),a.setFloat32(76,this.data.lowpower),a.setFloat32(80,this.data.mBattery4_Adjustment),a.setFloat32(84,this.data.mVoltage_Equal),a.setFloat32(88,this.data.mOvercharge_Release_Voltage),a.setFloat32(92,this.data.mOvercharge_Cell_voltage),a.setFloat32(96,this.data.mDischarge_Release_Voltage),a.setFloat32(100,this.data.mDischarge_Cell_Voltage);var i=parseInt(65535&c(104,e));a.setUint8(104,255&i),i>>=8,a.setUint8(105,255&i),a.setUint16(106,23205),this.blueArrayBufferSend(e)}},selectionFunc:function(t){parseInt(t.detail.value)==this.data.passWord&&this.setData({isCurrentOutAdjustEN:!1,isCurrentInAdjustEN:!1,isRePassWordEN:!1,isReNameEN:!1})},clearmOut_cycle:function(t){this.data.autoSendEn=!1;var e=new ArrayBuffer(6),a=new DataView(e);a.setUint16(0,43690),a.setUint32(2,this.data.passWord),this.blueArrayBufferSend(e)},clickpopExit:function(t){var e=this.data.pwEntertemp;wx.setStorageSync("passWord",e),this.data.passWord=parseInt(e),this.setData({popshow:!1,showwarn:"密码设置成功"})},pwEnter:function(t){this.data.pwEntertemp=t.detail.value},completeinput:function(t){this.setData({popshow:!1})},listenerSwitchOUT:function(t){var e=t.detail.value;s=!1,this.data.isSwitchChange=parseInt(this.data.isSwitchChange)+1;var i=new DataView(a);e?i.setUint16(0,34181):i.setUint16(0,34438),r=2},listenerSwitchIN:function(t){var e=t.detail.value;s=!1,this.data.isSwitchChange=parseInt(this.data.isSwitchChange)+1;var i=new DataView(a);e?i.setUint16(0,55512):i.setUint16(0,55769),r=2},drawCurrent:function(t){var e=this.data.currentCanvas;if(null!=e){var a=[5,10,15],i=e.width,r=e.height,s=wx.getSystemInfoSync().pixelRatio,l=e.getContext("2d"),d=34*s,u=18*s,c=r-u,h=i-5*s,g=u+4*s,_=(c-u)/6,f=(h-d)/6,m=d-4*s,v=0,p=3*_+u,C=(c-u)/2;o>0?o-=1:o=59,n[o]=t;for(var w,F=0,x=0;x<60;x++)(w=Math.abs(n[x]))>F&&(F=w);var U=C/15;for(Math.abs(F)<15?a=[5,10,15]:Math.abs(F)<30?(a=[10,20,30],U=C/30):Math.abs(F)<60?(a=[20,40,60],U=C/60):Math.abs(F)<120?(a=[40,80,120],U=C/120):Math.abs(F)<240?(a=[80,160,240],U=C/240):Math.abs(F)<480?(a=[160,320,480],U=C/480):Math.abs(F)<960?(a=[320,640,960],U=C/960):Math.abs(F)<1920&&(a=[640,1280,1920],U=C/1920),l.clearRect(0,0,i,r),l.beginPath(),l.lineWidth=s,l.strokeStyle="#EEEEEE",v=0;v<7;v++)l.moveTo(d,_*v+u),l.lineTo(h,_*v+u);for(l.stroke(),l.beginPath(),l.fillStyle="#444444",l.textAlign="right",l.font="38px sans-serif",l.fillText("-"+a[2],m,g),l.fillText("-"+a[1],m,g+_),l.fillText("-"+a[0],m,g+2*_),l.fillText(0,m,g+3*_),l.fillText(a[0],m,g+4*_),l.fillText(a[1],m,g+5*_),l.fillText(a[2],m,g+6*_),g=c+14*s,m=76*s,v=0;v<6;v++)l.fillText(10+10*v,f*v+m,g);l.beginPath(),l.fillStyle="#3C3C3C",l.textAlign="left",l.font="40px sans-serif",t>0?l.fillText("充电电流: "+t+"A     MAX:"+F.toFixed(2)+"A",d+2*s,u-4*s):l.fillText("放电电流: "+t+"A     MAX:"+F.toFixed(2)+"A",d+2*s,u-4*s);var y,T=(h-d+3*s)/60,I=o,S=d+s,D=0;l.beginPath(),l.lineWidth=s,l.strokeStyle="#FFFFFF";var E=l.createLinearGradient(0,0,0,520);for(E.addColorStop(0,"#FFF426"),E.addColorStop(.6,"#E3FFFD"),E.addColorStop(1,"#FFFFFF"),l.fillStyle=E,l.lineJoin="round",l.globalAlpha=.9,l.moveTo(S+59*T,c),l.lineTo(S-s,c),D=n[I],l.lineTo(S-s,p+D*U),v=0;v<59;v++)(y=I+1)>59&&(y=0),D=n[y],l.lineTo(S+T*(v+1),p+D*U),(I+=1)>59&&(I=0);for(l.stroke(),l.fill(),l.beginPath(),l.lineWidth=s,l.strokeStyle="#EF8641",l.lineJoin="round",D=n[I=o],l.moveTo(S,p+D*U),v=0;v<59;v++)(y=I+1)>59&&(y=0),D=n[y],l.lineTo(S+T*(v+1),p+D*U),(I+=1)>59&&(I=0);l.stroke(),l.beginPath(),l.fillStyle="#EF8641",l.arc(S,p+n[o]*U,2*s,0,2*Math.PI),l.fill()}},onLoad:function(){var t=parseInt(wx.getStorageSync("passWord"));if(t>99999&&(this.data.passWord=t),this.data.device=e.globalData.ble_device,null!=this.data.device){var a=this.data.device.deviceId;this.startConnecting(a)}},onReady:function(){var t=this,e=1,a=wx.createSelectorQuery();a.in(this),a.select("#currentcurve").fields({node:!0,size:!0}).exec((function(a){e=wx.getSystemInfoSync().pixelRatio,t.data.currentCanvas=a[0].node,t.data.currentCanvas.width=a[0].width*e,t.data.currentCanvas.height=a[0].height*e})),setTimeout((function(){try{t.drawCurrent(0)}catch(t){}}),600)},onUnload:function(){this.data.dautoConnectEn=!1,wx.closeBLEConnection({deviceId:d}),this.data.connected=!1,clearInterval(i),this.data.autoTimerOK=!1},startConnecting:function(t){var a=this;d=this.data.device.deviceId,this.serviceu=e.globalData.mserviceuuid.toUpperCase(),this.serviceu2=e.globalData.mserviceuuid2.toUpperCase(),this.txdu=e.globalData.mtxduuid.toUpperCase(),this.rxdu=e.globalData.mrxduuid.toUpperCase(),this.txdu2=e.globalData.mtxduuid2.toUpperCase(),this.rxdu2=e.globalData.mrxduuid2.toUpperCase(),this.setData({deviceadd:"MAC "+t,showwarn:"正在连接到："+t}),wx.createBLEConnection({deviceId:t,timeout:15e5,success:function(e){a.setData({showwarn:"正在配置蓝牙服务......"}),a.getBLEDeviceServices(t)},fail:function(t){10003==t.errCode?(wx.closeBLEConnection({deviceId:d}),a.setData({dautoConnectEn:!0,showwarn:"10秒后尝试重新连接......"})):a.setData({showwarn:"("+t.errCode+")连接失败请重启APP......"}),wx.closeBLEConnection({deviceId:d})}});wx.setBLEMTU({deviceId:t,mtu:128,success:function(t){this.setData({showwarn:"mtu_ok"})},fail:function(t){this.setData({connected:!1,showwarn:"mtu_false"})}})},getBLEDeviceServices:function(t){var e=this,a=this,i=!1;wx.getBLEDeviceServices({deviceId:t,success:function(r){for(var s=0;s<r.services.length;s++)e.serviceu!=r.services[s].uuid&&e.serviceu2!=r.services[s].uuid||(i=!0,a.setData({showwarn:"获取服务成功......"}),e.getBLEDeviceCharacteristics(t,r.services[s].uuid))}}),i||a.setData({showwarn:"设备选择不正确......"})},getBLEDeviceCharacteristics:function(t,e){var a=this,r=this;wx.getBLEDeviceCharacteristics({deviceId:t,serviceId:e,success:function(s){var n=!1;e!=a.serviceu&&e!=a.serviceu2||(n=!0);for(var o=0;o<s.characteristics.length;o++){var l=s.characteristics[o];l.properties.write&&(a._deviceId=t,(n&&a.txdu==l.uuid||n&&a.txdu2==l.uuid)&&(a._characteristicId=l.uuid,a._serviceId=e)),(l.properties.notify||l.properties.indicate)&&(n&&a.rxdu==l.uuid||n&&a.rxdu2==l.uuid)&&wx.notifyBLECharacteristicValueChange({deviceId:t,serviceId:e,characteristicId:l.uuid,state:!0,success:function(t){r.setData({connected:!0,showwarn:"蓝牙连接成功......"}),r.data.autoTimerOK||(r.data.autoTimerOK=!0,i=setInterval((function(){r.blueAutosend()}),1200))}})}},fail:function(t){}}),
wx.onBLECharacteristicValueChange((function(t){l<<=1;var e=new DataView(t.value),a=e.getUint8(0);if(1==a){if(e.byteLength<40)return;var i="",n=e.getUint8(3);if(0==n){var o=e.getUint32(32);i="系统已经运行: "+parseInt(o/86400)+"天 "+parseInt(o%86400/3600)+"时 "+parseInt(o%86400%3600/60)+"分钟"}else(1&n)>0?i="总电压过充保护已经开启":(2&n)>0?i="单体电压过充保护已经开启":(4&n)>0?i="充电过流保护已开启":(8&n)>0?i="放电过流保护已开启":(16&n)>0?i="总电压过放已开启":(32&n)>0?i="单体电压过放已开启":(64&n)>0?i="高温保护已开启":(128&n)>0&&(i="短路保护已开启");var d=e.getFloat32(12).toFixed(2),h=e.getFloat32(8).toFixed(2);if(h>d&&(d=0-h),r.drawCurrent(d),s){var g=e.getUint8(2);if(r.data.isSwitchChange!=g){r.data.isSwitchChange=g;var _=!1;
1&g&&(_=!0);var f=!1;2&g&&(f=!0),r.setData({switchOutStatus:_,switchInStatus:f})}}else s=!0;
r.setData({mVoltage:e.getFloat32(4).toFixed(3),showCurrent:d,mpower:(d*e.getFloat32(4)).toFixed(2),t1:e.getFloat32(16).toFixed(1),t2:e.getFloat32(20).toFixed(1),mCurent_Out_SUM:e.getFloat32(24).toFixed(3),mCurent_In_SUM:e.getFloat32(28).toFixed(3),showwarn:i,mOut_cycle:e.getUint16(36),mBattery_capacity:e.getUint16(38)})}else if(2==a){if(e.byteLength<40)return;for(var m=e.getUint8(2),v=e.getUint32(8),p=0;p<24;p++)r.data.cellVotage[p]=p<m?e.getFloat32(24+4*p).toFixed(3):0;for(var C,w,F=r.data.cellVotage,x=15.5,U=0,y=0,T=0;T<m;T++)F[T]>U&&(U=F[T],C=T),F[T]<x&&(x=F[T],w=T),y=parseFloat(y)+parseFloat(F[T]);if(F[12]==x&&U-x<.015&&U-x>.005&&0==(16777215&v)){F[12]=(parseFloat(F[12])+parseFloat(.003)).toFixed(3),x=15.5,U=0,y=0;for(var I=0;I<m;I++)F[I]>U&&(U=F[I],C=I),F[I]<x&&(x=F[I],w=I),y=parseFloat(y)+parseFloat(F[I])}var S=(y/m).toFixed(3);if(m>3){for(var D=0;D<24;D++)r.data.battryIMG[D]=D<m?D==C?"f.png":D==w?"n.png":"e.png":"e.png";var E=r.data.battryIMG;r.setData({battryIMG:E})}if(r.setData({cellVotage:F,showMax:U,showMin:x,max_Min:(U-x).toFixed(3),showaverage:S,showAllVoltage:y.toFixed(3),showEqual:e.getFloat32(20).toFixed(3)}),(16777215&v)>0){r.data.equaloff=0;for(var V=r.data.equalIMG,b=r.data.equalText,O=0;O<24;O++)O<m&&parseInt(v&1<<O)>0?(V[O]="m.png",b[O]="打开"):(V[O]="e.png",b[O]="关闭");r.setData({equalIMG:V,equalText:b})}else if(r.data.equaloff++,r.data.equaloff<6&&r.data.equaloff>3){for(var B=r.data.equalIMG,N=r.data.equalText,A=0;A<24;A++)B[A]="e.png",N[A]="关闭";r.setData({equalIMG:B,equalText:N})}}else if(3==a){if(e.byteLength<108)return;var M=c(104,t.value),R=57344&(M&=65535);if(M=M<<3&65528,(M|=R=R>>13&7)!=(R=e.getUint16(104)))return;r.setData({order:3,sLength:108,blePassWord:e.getUint32(2),mOffset_Voltage_OUT:e.getUint8(6),mOffset_Voltage_IN:e.getUint8(7),mCurrent_IN_Max:e.getUint16(8),mCurrent_Out_Max:e.getUint16(10),mCurrent_IN_Zero:e.getUint8(12),mCurrent_OUT_Zero:e.getUint8(13),mBattery_Count:e.getUint8(14),mbattery_Type:e.getUint8(15),mNC2:e.getUint16(16),mDischarge_cycle:e.getUint16(18),mBattery_Capacity:parseFloat(e.getFloat32(20).toFixed(3)),mBalanced_Open_Voltage:parseFloat(e.getFloat32(24).toFixed(3)),mReference_OUT_Voltage:parseFloat(e.getFloat32(32).toFixed(3)),mReference_IN_Voltage:parseFloat(e.getFloat32(36).toFixed(3)),mTotal_Discharge:parseFloat(e.getFloat32(40).toFixed(3)),mTotal_Recharge:parseFloat(e.getFloat32(44).toFixed(3)),mCell_voltage_discharge:parseFloat(e.getFloat32(48).toFixed(3)),mCell_voltage_overcharge:parseFloat(e.getFloat32(52).toFixed(3)),mMOS_Temperature_Protect:parseFloat(e.getFloat32(56).toFixed(3)),mCircuit_Temperature_Protect:parseFloat(e.getFloat32(60).toFixed(3)),mTemperature_Adjustment:parseFloat(e.getFloat32(64).toFixed(3)),serial_number:e.getUint32(68),softDate:e.getUint32(72),lowpower:parseFloat(e.getFloat32(76).toFixed(3)),mBattery4_Adjustment:parseFloat(e.getFloat32(80).toFixed(3)),mVoltage_Equal:parseFloat(e.getFloat32(84).toFixed(3)),mOvercharge_Release_Voltage:parseFloat(e.getFloat32(88).toFixed(3)),mOvercharge_Cell_voltage:parseFloat(e.getFloat32(92).toFixed(3)),mDischarge_Release_Voltage:parseFloat(e.getFloat32(96).toFixed(3)),mDischarge_Cell_Voltage:parseFloat(e.getFloat32(100).toFixed(3)),keyStatus:"保存设置"})}else{var P=e.getUint32(0);555555555==P?31==(l|=1)&&(l=0,r.setData({popshow:!0})):898564898==P?u("数据错误"):565654321==P?u("配置文件保存成功"):563654341==P?u("蓝牙名称修改成功"):898989898==P?(r.data.passWord=r.data.repassword,wx.setStorageSync("passWord",r.data.repassword),u("密码修改成功")):898332213==P?u("电流校准成功"):798589898==P&&u("设置成功")}})),wx.onBLEConnectionStateChange((function(t){0==t.connected&&(wx.closeBLEConnection({deviceId:d}),r.data.dautoConnectEn=!0,r.setData({showwarn:"连接已经断开......"})),r.data.connected=t.connected}))},blueAutosend:function(){var t=this;if(t.data.connected)if(t.data.autoSendEn){if(0==r){var i=new DataView(a);if(i.setUint32(2,t.data.passWord),0==t.data.currentTab)i.setUint16(0,50433);else{if(1!=t.data.currentTab)return;i.setUint16(0,23298)}}else r=0;wx.writeBLECharacteristicValue({deviceId:t._deviceId,serviceId:t._serviceId,characteristicId:t._characteristicId,value:a,success:function(e){t.setData({})},fail:function(t){},complete:function(t){}})}else t.data.autoSendEn=!0;else if(t.data.dautoConnectEn)if(t.data.autoConnectconut<10)t.data.autoConnectconut++;else{if(t.data.autoConnectconut=0,t.data.dautoConnectEn=!1,t.data.device=e.globalData.ble_device,null==t.data.device)return;var s=t.data.device.deviceId;t.startConnecting(s)}},blueArrayBufferSend:function(t){this.data.connected?wx.writeBLECharacteristicValue({deviceId:this._deviceId,serviceId:this._serviceId,characteristicId:this._characteristicId,value:t,success:function(t){},fail:function(t){},complete:function(t){}}):this.setData({showwarn:"连接已经断开......"})},clearMore:function(){this.setData({isReNameEN:!0,isRePassWordEN:!0,isCurrentInAdjustEN:!0,isCurrentOutAdjustEN:!0})},trg_mTotal_Discharge:function(t){this.data.mTotal_Discharge=t.detail.value},trg_mTotal_Recharge:function(t){this.data.mTotal_Recharge=t.detail.value},trg_mDischarge_Release_Voltage:function(t){this.data.mDischarge_Release_Voltage=t.detail.value},trg_mOvercharge_Release_Voltage:function(t){this.data.mOvercharge_Release_Voltage=t.detail.value},trg_mCell_voltage_discharge:function(t){this.data.mCell_voltage_discharge=t.detail.value},trg_mCell_voltage_overcharge:function(t){this.data.mCell_voltage_overcharge=t.detail.value},trg_mDischarge_Cell_Voltage:function(t){this.data.mDischarge_Cell_Voltage=t.detail.value},trg_mOvercharge_Cell_voltage:function(t){this.data.mOvercharge_Cell_voltage=t.detail.value},trg_mMOS_Temperature_Protect:function(t){this.data.mMOS_Temperature_Protect=t.detail.value},trg_mCircuit_Temperature_Protect:function(t){this.data.mCircuit_Temperature_Protect=t.detail.value},trg_mVoltage_Equal:function(t){this.data.mVoltage_Equal=t.detail.value},trg_mCurrent_Out_Max:function(t){this.data.mCurrent_Out_Max=t.detail.value},trg_mCurrent_IN_Max:function(t){this.data.mCurrent_IN_Max=t.detail.value},trg_mBattery_Count:function(t){this.data.mBattery_Count=t.detail.value},trg_mBattery_Capacity:function(t){this.data.mBattery_Capacity=t.detail.value},trg_mBalanced_Open_Voltage:function(t){this.data.mBalanced_Open_Voltage=t.detail.value},trg_mbattery_Type:function(t){this.data.mbattery_Type=t.detail.value},trg_mTemperature_Adjustment:function(t){this.data.mTemperature_Adjustment=t.detail.value},trg_lowpower:function(t){this.data.lowpower=t.detail.value},trg_mReference_OUT_Voltage:function(t){this.data.mReference_OUT_Voltage=t.detail.value},trg_mReference_IN_Voltage:function(t){this.data.mReference_IN_Voltage=t.detail.value},calibrationOUT:function(t){this.data.settingSendChoose=1,this.data.recurrent=parseFloat(t.detail.value),this.setData({keyStatus:"放电电流校准",isReNameEN:!0,isRePassWordEN:!0,isCurrentInAdjustEN:!0})},sendcalibrationOUT:function(){if(this.data.recurrent<1)u("放电电流基准设置错误");else{var t=new ArrayBuffer(10),e=new DataView(t);e.setUint16(0,47545),e.setInt32(2,this.data.passWord),e.setFloat32(6,this.data.recurrent),this.blueArrayBufferSend(t)}},calibrationIN:function(t){this.data.settingSendChoose=2,this.data.recurrent=parseFloat(t.detail.value),this.setData({keyStatus:"充电电流校准",isReNameEN:!0,isRePassWordEN:!0,isCurrentOutAdjustEN:!0})},sendcalibrationIN:function(){if(this.data.recurrent<1)u("充电电流基准设置错误");else{var t=new ArrayBuffer(10),e=new DataView(t);e.setUint16(0,57054),e.setInt32(2,this.data.passWord),e.setFloat32(6,this.data.recurrent),this.blueArrayBufferSend(t)}},rePassWord:function(t){this.data.settingSendChoose=3,this.data.repassword=parseInt(t.detail.value),this.setData({keyStatus:"修改密码",isReNameEN:!0,isCurrentInAdjustEN:!0,isCurrentOutAdjustEN:!0})},sendrePassWord:function(){if(this.data.repassword<99999||this.data.repassword>4e9)u("请输入6至10位数字");else{var t=new ArrayBuffer(12),e=this.data.repassword,a=new DataView(t);a.setUint16(0,11621),a.setInt32(2,this.data.passWord),a.setUint8(6,e>>24&255),a.setUint8(7,e>>16&255),a.setUint8(8,e>>8&255),a.setUint8(9,255&e);var i=c(10,t);a.setUint8(10,255&i),a.setUint8(11,i>>8&255),this.blueArrayBufferSend(t)}},reBlueName:function(t){this.data.settingSendChoose=4,this.data.rebluename=t.detail.value,this.setData({keyStatus:"修改蓝牙名称",isRePassWordEN:!0,isCurrentInAdjustEN:!0,isCurrentOutAdjustEN:!0})},sendreBlueName:function(t){this.data.rebluename.length<2&&u("长度错误");var e=function(t){var e,a,i=new Array;e=t.length;for(var r=0;r<e;r++)(a=t.charCodeAt(r))>=65536&&a<=1114111?(i.push(a>>18&7|240),i.push(a>>12&63|128),i.push(a>>6&63|128),i.push(63&a|128)):a>=2048&&a<=65535?(i.push(a>>12&15|224),i.push(a>>6&63|128),i.push(63&a|128)):a>=128&&a<=2047?(i.push(a>>6&31|192),i.push(63&a|128)):i.push(255&a);return i}(this.data.rebluename),a=e.length,i=new ArrayBuffer(a+12),r=new DataView(i);r.setUint16(0,39321),r.setInt32(2,this.data.passWord),r.setUint16(6,39321);for(var s=0;s<a;s++)r.setUint8(s+8,e[s]);r.setUint8(a+8,13),r.setUint8(a+9,10),r.setUint8(a+10,254),this.blueArrayBufferSend(i)}});